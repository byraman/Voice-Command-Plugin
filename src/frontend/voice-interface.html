<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Interface - Figma Plugin</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f8f9fa;
            text-align: center;
        }
        .container {
            max-width: 400px;
            margin: 0 auto;
        }
        .title {
            color: #333;
            margin-bottom: 30px;
        }
        .info-message {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid #2196f3;
            font-size: 14px;
            color: #1565c0;
            text-align: left;
        }
        .transcript {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            min-height: 60px;
            border: 2px solid #e1e5e9;
            font-size: 16px;
            color: #333;
            text-align: left;
        }
        .status {
            color: #666;
            font-size: 14px;
            margin: 10px 0;
        }
        .mic-button {
            background: #007AFF;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            margin: 20px 0;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 122, 255, 0.3);
        }
        .mic-button:hover {
            background: #0056CC;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 122, 255, 0.4);
        }
        .mic-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .mic-button.listening {
            background: #FF3B30;
            animation: pulse 1.5s infinite;
        }
        .mic-button.stop {
            background: #FF3B30;
        }
        .mic-button.stop:hover {
            background: #D70015;
        }
        .mic-controls {
            display: flex;
            gap: 10px;
            margin: 20px 0;
        }
        .mic-controls .mic-button {
            flex: 1;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="title">üé§ Voice Interface</h1>
        
        <div class="info-message">
            <strong>This webpage is just used as a mic source since Figma doesn't support audio input natively.</strong>
        </div>
        
        <div class="mic-controls">
            <button id="micButton" class="mic-button">
                üé§ Start Listening
            </button>
            <button id="stopButton" class="mic-button stop" disabled>
                ‚èπÔ∏è Stop Listening
            </button>
        </div>
        
        <div id="transcript" class="transcript">
            Waiting for voice input...
        </div>
        
        <div id="status" class="status">
            Click the button to start voice recognition
        </div>
    </div>

    <script src="../config.js"></script>
    <script>
        class VoiceInterface {
            constructor() {
                this.isListening = false;
                this.recognition = null;
                this.silenceTimer = null;
                this.retryCount = 0;
                this.maxRetries = 2; // Reduced retries to prevent browser restrictions
                this.isInitialized = false;
                this.micButton = document.getElementById('micButton');
                this.stopButton = document.getElementById('stopButton');
                this.transcript = document.getElementById('transcript');
                this.status = document.getElementById('status');
                
                // Force HTTPS-only API URL
                this.apiUrl = this.getApiUrl();
                
                this.init();
            }
            
            getApiUrl() {
                // Always use HTTPS in production, allow localhost override via environment
                const isLocalDev = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
                const useLocalhost = window.USE_LOCALHOST === 'true' || window.USE_LOCALHOST === true;
                
                if (isLocalDev && useLocalhost) {
                    return 'http://localhost:3000';
                }
                
                // Default to Vercel HTTPS URL
                return window.API_BASE_URL || 'https://voice-command-plugin.vercel.app';
            }
            
            init() {
                console.log('üé§ Voice Interface initialized');
                console.log('üåê Using API URL:', this.apiUrl);
                
                // Only setup buttons, not recognition yet
                this.setupMicButtons();
                this.updateStatus('Click "Start Listening" to begin voice recognition');
            }
            
            setupMicButtons() {
                this.micButton.addEventListener('click', () => {
                    if (!this.isInitialized) {
                        this.initializeSpeechRecognition();
                    }
                    this.startRecognition();
                });
                
                this.stopButton.addEventListener('click', () => {
                    this.stopRecognition();
                });
            }
            
            initializeSpeechRecognition() {
                // Check HTTPS requirement first
                if (!this.isSecureContext()) {
                    this.updateStatus('Voice recognition requires HTTPS. Please access this page via HTTPS.');
                    return false;
                }
                
                if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    this.recognition = new SpeechRecognition();
                    
                    // Configure SpeechRecognition properly for HTTPS
                    this.recognition.continuous = true;
                    this.recognition.interimResults = true;
                    this.recognition.lang = 'en-US';
                    this.recognition.maxAlternatives = 1;
                    
                    this.recognition.onstart = () => {
                        console.log('Speech recognition started');
                        this.isListening = true;
                        this.updateUI();
                        this.updateStatus('Listening... Speak your command');
                    };
                    
                    this.recognition.onresult = (event) => {
                        let finalTranscript = '';
                        let interimTranscript = '';
                        
                        for (let i = event.resultIndex; i < event.results.length; i++) {
                            const transcript = event.results[i][0].transcript;
                            if (event.results[i].isFinal) {
                                finalTranscript += transcript;
                            } else {
                                interimTranscript += transcript;
                            }
                        }
                        
                        const displayText = finalTranscript || interimTranscript;
                        this.transcript.textContent = displayText;
                        
                        if (finalTranscript) {
                            console.log('üé§ Final transcript:', finalTranscript);
                            
                            // Send command to the server
                            this.sendCommand(finalTranscript);
                            
                            this.resetSilenceTimer();
                        } else if (interimTranscript.trim().length > 0) {
                            // Only reset timer if there's actual speech content
                            this.resetSilenceTimer();
                        }
                    };
                    
                    this.recognition.onend = () => {
                        console.log('Speech recognition ended');
                        this.isListening = false;
                        this.updateUI();
                        this.updateStatus('Stopped listening');
                    };
                    
                    this.recognition.onerror = (event) => {
                        console.error('Speech recognition error:', event.error, event);
                        this.isListening = false;
                        this.updateUI();
                        this.clearSilenceTimer();
                        
                        // Handle different error types - NO AUTO RETRY for most errors
                        if (event.error === 'not-allowed') {
                            this.updateStatus('Microphone access denied. Please click the microphone icon in your browser address bar and allow microphone access, then try again.');
                        } else if (event.error === 'no-speech') {
                            this.updateStatus('No speech detected. Click "Start Listening" to try again.');
                        } else if (event.error === 'audio-capture') {
                            this.updateStatus('No microphone found. Please check your microphone connection and try again.');
                        } else if (event.error === 'network') {
                            this.updateStatus('Network error. Please check your internet connection and try again.');
                            // Only retry network errors with controlled logic
                            if (this.retryCount < this.maxRetries) {
                                this.handleNetworkError();
                            }
                        } else if (event.error === 'aborted') {
                            this.updateStatus('Recognition stopped. Click "Start Listening" to try again.');
                        } else {
                            this.updateStatus(`Error: ${event.error}. Click "Start Listening" to try again.`);
                        }
                    };
                } else {
                    this.updateStatus('Speech recognition not supported in this browser');
                    return false;
                }
                
                this.isInitialized = true;
                return true;
            }
            
            isSecureContext() {
                return window.isSecureContext || 
                       window.location.protocol === 'https:' || 
                       window.location.hostname === 'localhost' || 
                       window.location.hostname === '127.0.0.1';
            }
            
            toggleListening() {
                if (this.isListening) {
                    this.stopRecognition();
                } else {
                    this.startRecognition();
                }
            }
            
            startRecognition() {
                if (!this.isInitialized) {
                    this.updateStatus('Initializing speech recognition...');
                    return;
                }
                
                if (this.recognition && !this.isListening) {
                    console.log('Starting speech recognition...');
                    try {
                        this.recognition.start();
                        this.resetSilenceTimer();
                        this.retryCount = 0; // Reset retry count on successful start
                    } catch (error) {
                        console.error('Error starting recognition:', error);
                        this.updateStatus('Error starting recognition: ' + error.message + '. Click "Start Listening" to try again.');
                    }
                } else if (this.isListening) {
                    this.updateStatus('Already listening. Click "Stop Listening" first.');
                }
            }
            
            handleNetworkError() {
                this.retryCount++;
                console.log(`Retrying recognition (attempt ${this.retryCount}/${this.maxRetries})...`);
                
                setTimeout(() => {
                    if (this.retryCount <= this.maxRetries && !this.isListening) {
                        this.startRecognition();
                    } else if (this.retryCount > this.maxRetries) {
                        this.updateStatus('Max retries reached. Please check your internet connection and try again.');
                    }
                }, 3000); // Fixed delay, not exponential
            }
            
            stopRecognition() {
                if (this.recognition && this.isListening) {
                    console.log('Stopping speech recognition...');
                    this.recognition.stop();
                    this.clearSilenceTimer();
                }
            }
            
            resetSilenceTimer() {
                this.clearSilenceTimer();
                this.silenceTimer = setTimeout(() => {
                    console.log('Silence detected after 5 seconds, stopping recognition...');
                    if (this.isListening) {
                        this.stopRecognition();
                        this.updateStatus('Silence detected. Click "Start Listening" to try again.');
                    }
                }, 5000);
            }
            
            clearSilenceTimer() {
                if (this.silenceTimer) {
                    clearTimeout(this.silenceTimer);
                    this.silenceTimer = null;
                }
            }
            
            async sendCommand(command) {
                // Don't block mic functionality if API fails
                try {
                    console.log(`Sending command to: ${this.apiUrl}`);
                    
                    const response = await fetch(`${this.apiUrl}/api/commands`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json',
                        },
                        body: JSON.stringify({ transcript: command.trim() })
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        console.log('Command sent successfully:', result);
                        this.updateStatus(`Command sent: "${command}"`);
                        this.transcript.textContent = 'Command sent! Waiting for next command...';
                    } else {
                        console.error('Server error:', response.status, response.statusText);
                        this.updateStatus(`Command received: "${command}" (Server error: ${response.status})`);
                    }
                } catch (error) {
                    console.error('Error sending command:', error);
                    // Don't fail the mic experience if API is down
                    this.updateStatus(`Command received: "${command}" (Offline mode - server unavailable)`);
                    this.transcript.textContent = 'Command received! Waiting for next command...';
                }
            }
            
            
            updateUI() {
                if (this.isListening) {
                    this.micButton.classList.add('listening');
                    this.micButton.disabled = true;
                    this.stopButton.disabled = false;
                } else {
                    this.micButton.classList.remove('listening');
                    this.micButton.disabled = false;
                    this.stopButton.disabled = true;
                }
            }
            
            updateStatus(message) {
                this.status.textContent = message;
            }
        }
        
        // Initialize the voice interface
        document.addEventListener('DOMContentLoaded', () => {
            // Check if we're on HTTPS or localhost
            if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
                document.body.innerHTML = `
                    <div class="container">
                        <h1 class="title">üîí HTTPS Required</h1>
                        <div class="info-message">
                            <strong>Voice recognition requires HTTPS or localhost.</strong><br>
                            Please access this page via HTTPS or run it locally.
                        </div>
                    </div>
                `;
                return;
            }
            
            new VoiceInterface();
        });
    </script>
</body>
</html>