<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Control Figma with Voice</title>
  <style>
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 0;
      background: #181818;
      color: #ffffff;
      width: 400px;
      height: 480px;
      overflow: hidden;
    }
    
    .container {
      padding: 24px;
      height: 100%;
      display: flex;
      flex-direction: column;
    }
    
    h1 {
      color: #ffffff;
      text-align: center;
      margin: 0 0 24px 0;
      font-size: 24px;
      font-weight: 500;
    }
    
    .separator {
      height: 1px;
      background: #272727;
      margin: 0 0 20px 0;
    }
    
    .chrome-badge {
      background: #281E0A;
      color: #FF8922;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 700;
      font-family: 'SF Mono', 'Monaco', 'Menlo', 'Consolas', 'Courier New', monospace;
      display: inline-block;
      margin-bottom: 16px;
      letter-spacing: 0.5px;
    }
    
    .link-section {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 20px;
    }
    
    .link-field {
      flex: 1;
      background: #212121;
      border: 1px solid #2f2f2f;
      border-radius: 6px;
      padding: 10px 12px;
      display: flex;
      align-items: center;
      gap: 8px;
      color: #fff;
      font-size: 13px;
    }
    
    .link-icon {
      width: 16px;
      height: 16px;
      color: #777777;
      flex-shrink: 0;
    }
    
    .link-text {
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    .open-button {
      background: #ffffff;
      color: #1a1a1a;
      border: none;
      border-radius: 6px;
      padding: 10px 20px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s ease;
      flex-shrink: 0;
    }
    
    .open-button:hover {
      background: #cacaca;
    }
    
    .open-button:active {
      background: #ededed;
    }
    
    .disclaimer-section {
      margin-top: 20px;
    }
    
    .disclaimer-title {
      color: #999999;
      font-size: 11px;
      font-weight: 500;
      font-family: 'SF Mono', 'Monaco', 'Menlo', 'Consolas', 'Courier New', monospace;
      margin: 0 0 12px 0;
    }
    
    .disclaimer-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    
    .disclaimer-list li {
      color: #ffffff;
      font-size: 12px;
      line-height: 1.6;
      margin-bottom: 8px;
      padding-left: 16px;
      position: relative;
    }
    
    .disclaimer-list li:before {
      content: "â€¢";
      position: absolute;
      left: 0;
      color: #999999;
    }
    
    .disclaimer-list li:last-child {
      margin-bottom: 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Control Figma with Voice</h1>
    
    <div class="separator"></div>
    
    <div class="chrome-badge">CHROME REQUIRED</div>
    
    <div class="link-section">
      <div class="link-field">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="link-icon">
          <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>
          <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>
        </svg>
        <span class="link-text">voice-command-plugin.vercel.app</span>
      </div>
      <button id="openButton" class="open-button">Open</button>
    </div>
    
    <div class="separator"></div>
    
    <div class="disclaimer-section">
      <div class="disclaimer-title">Disclaimer & how to use:</div>
      <ul class="disclaimer-list">
        <li>Open the link in Chrome browser, give mic permissions and start giving voice commands to Figma, it'll execute on the canvas!</li>
        <li>Since Figma doesn't support microphone access, so a webpage is used as a workaround.</li>
        <li>Try "create a dark grey frame", "add a circle inside Frame 6", "add a rounded rectangle in the middle of Group 4".</li>
      </ul>
    </div>
  </div>

  <script>
    let pluginId = null;
    let apiUrl = 'https://voice-command-plugin.vercel.app'; // Default fallback

    // Listen for messages from main plugin code
    window.onmessage = (event) => {
      console.log('UI received message:', event.data);
      
      // Handle both direct data and pluginMessage format
      const data = event.data.pluginMessage || event.data;
      
      if (data && data.type === 'plugin-id') {
        pluginId = data.pluginId;
        console.log('Received plugin ID:', pluginId);
      } else if (data && data.type === 'api-url') {
        // Update API URL if received (though we detect it ourselves)
        if (data.apiUrl) {
          apiUrl = data.apiUrl;
          console.log('Received API URL from plugin:', apiUrl);
        }
      }
    };

    // Auto-detect API URL (same logic as plugin code)
    async function detectApiUrl() {
      try {
        const localhostUrl = 'http://localhost:3000';
        const response = await fetch(`${localhostUrl}/api/health`, { 
          method: 'GET'
        });
        if (response.ok) {
          console.log('UI: Localhost server detected');
          return localhostUrl;
        }
      } catch (error) {
        console.log('UI: Localhost not available, using Vercel');
      }
      return 'https://voice-command-plugin.vercel.app';
    }

    // Detect API URL on load
    (async () => {
      apiUrl = await detectApiUrl();
      console.log('UI: Using API URL:', apiUrl);
    })();

    function openVoiceInterface() {
      const url = pluginId ? `${apiUrl}?pluginId=${pluginId}` : apiUrl;
      
      console.log('Opening voice interface with URL:', url);
      console.log('Current apiUrl:', apiUrl);
      console.log('Current pluginId:', pluginId);
      
      const voiceWindow = window.open(
        url,
        'voiceInterface',
        'width=500,height=400,scrollbars=yes,resizable=yes'
      );

      if (voiceWindow) {
        console.log('Voice interface opened successfully at:', url);
      } else {
        console.error('Failed to open voice interface. Check popup blockers. URL was:', url);
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      const openButton = document.getElementById('openButton');
      if (openButton) {
        openButton.addEventListener('click', openVoiceInterface);
      }
    });
  </script>
</body>
</html>
